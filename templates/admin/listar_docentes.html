{% extends "base.html" %}
{% block title %}Listado de Docentes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Listado de Docentes</h1>
    <a href="{{ url_for('admin.crear_docente') }}" class="btn btn-sm btn-outline-secondary">Crear Nuevo Docente</a>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Grado Académico</th>
                <th>Paterno</th>
                <th>Materno</th>
                <th>Nombre</th>
                <th>Fecha Ingreso U.E.</th>
                <th>Fecha Titulacion</th>
                <th>Usuario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for docente in docentes %}
            <tr>
                <td>{{ docente.id_docente }}</td>
                <td>{{ docente.grado_academico }}</td>
                <td>{{ docente.paterno }}</td>
                <td>{{ docente.materno }}</td>
                <td>{{ docente.nombre }}</td>
                <td>{{ docente.fecha_ingreso_ue.strftime('%d/%m/%Y') if docente.fecha_ingreso_ue else '-' }}</td>
                <td>{{ docente.fecha_titulacion.strftime('%d/%m/%Y') if docente.fecha_titulacion else '-' }}</td>
                <td>{{ docente.usuario.nombre_usuario }}</td>
                <td>
                    <a href="{{ url_for('admin.editar_docente', id_docente=docente.id_docente) }}" class="btn btn-sm btn-warning me-1" title="Editar">Editar</a>
                    <a href="{{ url_for('admin.reporte_horario_docente') }}" class="btn btn-sm btn-secondary me-1" title="Ver Horario">Horario</a>

                    <button class="btn btn-sm btn-info me-1" onclick="verDetallesDocente({{ docente.id_docente }})" data-bs-toggle="modal" data-bs-target="#modalDetallesDocente" title="Ver Información Completa">Detalles</button>
                    <form action="{{ url_for('admin.eliminar_docente', id_docente=docente.id_docente) }}" method="post" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este docente? Esta acción no se puede deshacer.');" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" class="text-center">No hay docentes registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalDetallesDocente" tabindex="-1" aria-labelledby="modalDetallesDocenteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetallesDocenteLabel">Información Completa del Docente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="cuerpoModalDocente">

                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function verDetallesDocente(idDocente) {
        alert(`PASO 1: Iniciando función. ID Docente: ${idDocente}`);
        
        const modalBody = document.getElementById('cuerpoModalDocente');
       
        modalBody.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        
        alert('PASO 2: Spinner mostrado. Preparando llamada fetch...');

        fetch(`/admin/obtener_datos_docente/${idDocente}`)
            .then(response => {
                alert(`PASO 3: Respuesta cruda recibida. Status: ${response.status}. Status Text: ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                alert('PASO 4: Respuesta OK. Intentando parsear JSON...');
                return response.json();
            })
            .then(datos => {
                alert(`PASO 5: JSON parseado con éxito. Datos: ${JSON.stringify(datos)}`);

                if (datos.error) {
                    throw new Error(datos.error);
                }
                alert('PASO 6: Datos correctos. Llamando a mostrarDatosEnModal...');
                mostrarDatosEnModal(datos);
            })
            .catch(error => {
                alert(`PASO 7: ERROR CAPTURADO EN .catch()! Error: ${error.message}`);
                console.error('Error al obtener los datos:', error);
                modalBody.innerHTML = `<div class="alert alert-danger" role="alert"><h4>Error al cargar la información</h4><p>${error.message}</p></div>`;
            });
    }

    function mostrarDatosEnModal(datos) {
        alert('PASO 8: Función mostrarDatosEnModal iniciada.');
        let html = `
            <div class="row">
                <div class="col-md-8">
                    <h5>Datos Personales y Laborales</h5>
                    <p><strong>C.I.:</strong> ${datos.ci}</p>
                    <p><strong>Nombre Completo:</strong> ${datos.paterno} ${datos.materno} ${datos.nombre}</p>
                    <p><strong>Especialidad:</strong> ${datos.especialidad || 'No registrada'}</p>
                    <p><strong>Grado Académico:</strong> ${datos.grado_academico || 'No registrado'}</p>
                    <p><strong>Fecha de Ingreso U.E.:</strong> ${datos.fecha_ingreso_ue || 'No registrada'}</p>
                    <p><strong>Fecha de Titulación:</strong> ${datos.fecha_titulacion || 'No registrada'}</p>
                    <p><strong>Correo:</strong> ${datos.correo || 'No registrado'}</p>
                    <p><strong>Teléfono:</strong> ${datos.telefono || 'No registrado'}</p>
                </div>
                <div class="col-md-4 text-center">
                    <h5>Foto</h5>
                    <img src="${datos.foto ? '{{ url_for('static', filename='uploads/') }}' + datos.foto : '{{ url_for('static', filename='img/default_user.png') }}'}" 
                         alt="Foto de ${datos.nombre}" class="img-fluid rounded" style="max-height: 200px; border: 1px solid #ddd;">
                </div>
            </div>
            <hr>
            <h5>Datos de Acceso</h5>
            <p><strong>Usuario:</strong> ${datos.nombre_usuario}</p>
            <hr>
            <h5>Cursos y Materias Asignadas</h5>
        `;

        if (datos.asignaciones && datos.asignaciones.length > 0) {
            html += '<ul class="list-group">';
            datos.asignaciones.forEach(asig => {
                html += `<li class="list-group-item"><i class="fas fa-book-open"></i> <strong>${asig.curso}</strong> - ${asig.materia}</li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted">Este docente no tiene asignaciones.</p>';
        }

        alert('PASO 9: HTML construido. Inyectando en el modal...');
        document.getElementById('cuerpoModalDocente').innerHTML = html;
        alert('PASO 10: Proceso completado.');
    }
</script>
{% endblock %}